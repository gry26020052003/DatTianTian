<?php 
session_start();
echo'<html>
<head>
	<link rel="stylesheet" type="text/css" href="../includes/SSfonts.css" />
</head>
<body>';
require_once("../includes/sshdr.html");
require_once("../includes/bsa-conn.php"); 
require_once("../includes/functions.php");

if(isset($_GET['cycle']))
	$cycle = $_GET['cycle'];
else
	$cycle = NULL;

if(isset($_GET['period'])) 
	$period = $_GET['period'];
else
	$period = NULL;

echo '<h1>Applications By Time period</h1>
<h2>'.$cycle." ".$period.'</h2>
	<table>
		<tr>
			<th>Country</th>
    	<th>Program</th>
    	<th>Option</th>
    	<th>By Reg.<br />Deadline</th>
    	<th>By Ext.<br />Deadline</th>
    	<th>Late app</th>
    	<th>Total</th>
		</tr>';

//get list of program-options for a certain time period
$query = "SELECT country, program, programOption, eapprogramoptions.id AS eapProgramOptions_Id, appDeadline_BPSA_Begin, appDeadline_BPSA_End, extendedAppDeadline_BPSA_End
	  FROM eapprogramoptions, countries_eapdesignated
	  WHERE cycle = '" . $cycle . "'
	  AND period = '" . $period . "'
	  AND countries_eapdesignated.id = eapprogramoptions.countries_EAPDesignated_Id
	  GROUP BY country, program, programOption, eapprogramoptions.id, appDeadline_BPSA_Begin, appDeadline_BPSA_End, extendedAppDeadline_BPSA_End
	  ORDER BY country, program, programOption";
		
$result = mysql_query($query);

if ($result) {
	$num_rows = mysql_num_rows($result);
} else {
	$num_rows = 0;
} //end if

for ($i = 0; $i < $num_rows; $i++) 
{
	$row = mysql_fetch_array($result);
	$eapProgramOptions_Id = $row['eapProgramOptions_Id'];
	$country = displayText($row['country']);
	$program = displayText($row['program']);
	$programOption = displayText($row['programOption']);	
	$appDeadline_BPSA_End = displayDate($row['appDeadline_BPSA_End']);
	$extendedAppDeadline_BPSA_End = displayDate($row['extendedAppDeadline_BPSA_End']);	
	
echo '<tr>
<td>'.$country.'</td>
<td>'.$program.'</td>
<td>'.$programOption.'</td>
<td>';
	
	 // before regular application deadline ended
	 $query2 = "SELECT eap_ap.id AS eap_AP_Id, effectiveDate
		FROM eap_ap, eap_ap_eapstatuses, eapstatuses
		WHERE eapProgramOptions_Id = " . $eapProgramOptions_Id . "
		AND eap_ap.id = eap_ap_eapstatuses.eap_AP_Id  
		AND eapstatuses.id = eap_ap_eapstatuses.eapStatuses_Id
		AND status = 'Received'
		AND effectiveDate <= '" . $appDeadline_BPSA_End . "'";
	
	$result2 = mysql_query($query2);

	if ($result2)
		$num_rows2 = mysql_num_rows($result2);
	else
		$num_rows2 = 0;
 //end if
	$cnt_ByRegularDeadline = 0;

	for ($i2 = 0; $i2 < $num_rows2; $i2++) 
	{
		$row2 = mysql_fetch_array($result2);
		$eap_AP_Id = $row2['eap_AP_Id'];
		$cnt_ByRegularDeadline++;
	} //end for
	echo $cnt_ByRegularDeadline.'</td>';
} //end for (list of all program-options)
echo '</tr>
<tr>
	<td></td>
	<td></td>
	<td></td>
	<td></td>
</tr>
</table>
<p><sup>*</sup>Withdrawal rate</p>';
